# EMT (OSDI'25) 

【Title】EMT: An OS Framework for New Memory Translation Architectures



## Comments



## Introduction

虚拟内存地址转换已成为新兴内存密集型计算的主要性能瓶颈。随着TB级内存和CXL内存扩展器推动内存容量空前增长，TLB无法像内存那样线性扩展。此外，机器学习、图计算和生物信息学等新兴工作负载具有局部性较弱的非规则内存访问模式，导致TLB和其他MMU缓存效率降低。因此，TLB缺失率不可避免地上升，引发整个内存系统的高开销地址转换。

然而，当前的地址转换架构设计于内存稀缺时代，优先优化空间效率而非性能。主流方案采用多级Radix Tree组织转换表项；当TLB缺失时，内存管理单元(MMU)必须顺序遍历树结构（Page Table Walk），导致多次内存访问。x86-64架构采用四级树结构，近期硬件已扩展至五级。在虚拟化环境中，嵌套地址转换进一步放大了开销——需在客户机与宿主机页表间进行二维遍历，四级页表下会产生多达24次顺序内存访问。

为解决这一迫切问题，当前已开发出多种新型MMU硬件架构以实现TB级异构内存的快速地址转换。例如，基于哈希的转换方案被重新审视，因为哈希本质上比遍历树结构更具可扩展性；近期提出的弹性布谷鸟页表哈希方案通过支持页表项并行查找，被证实可显著降低转换开销。此外，采用扁平化或线性页表的新转换方案也已被开发出来。最新研究还提倡使用混合转换架构，通过组合或选择性应用不同方案来优化性能。

遗憾的是，操作系统对硬件创新的支持仍显不足：前文提及的新型硬件方案鲜少在Linux等商用操作系统中进行实验验证。当前对实验性架构的评估主要采用两种方法：一是通过性能模型估算操作系统开销，二是在未修改的Linux系统上运行工作负载收集跟踪数据后进行 trace-driven模拟。这些方法隐含假设不同地址转换架构下的操作系统开销恒定不变。然而，本文研究揭示地址转换架构会对操作系统性能产生重大影响。

事实上，操作系统支持的困难已经影响了硬件研究——颠覆性的硬件设计常被视为"不切实际"而输给渐进式改良方案。我们与硬件厂商的讨论表明，缺乏商用操作系统支持和评估是阻碍新型硬件转换方案验证与采用的主要障碍。

当前操作系统支持不足的主要原因在于商用操作系统的内存管理系统缺乏对新兴地址转换架构的扩展能力。例如，Linux基于Radix Tree的页表结构假设使其无法支持不符合该树形定义的硬件方案。因此，支持新架构通常需要对架构无关的内存管理代码进行大量修改。本质上，Linux没有像其他子系统（如文件系统的VFS[51]）那样为内存转换提供可扩展接口。

### Contributions

我们在Linux基础上开发了一套实用的操作系统框架和工具链，以适配当今内存技术的新型硬件地址转换架构。该框架被命名为"可扩展内存转换"(Extensible Memory Translation, EMT)。选择Linux作为基础平台，因其仍是事实上的商用操作系统标准，且被大多数内存系统架构研究采用。

EMT提供架构中立的Linux接口，具备四大核心特性：

* 支持多样化的内存转换架构
* 实现硬件专属优化
* 兼容现代硬件和操作系统复杂性
* 相比Linux硬编码实现的开销可忽略不计

通过抽象转换相关操作，EMT显著简化了在Linux上支持和实验新型转换架构的工作量。开发者仅需实现MMU驱动作为转换逻辑的硬件特定实现，无需修改架构无关的内存管理代码。EMT还便于分析和评估不同硬件转换方案下的操作系统性能。

我们在Linux v5.15上实现了EMT（称为EMT-Linux），通过EMT API将架构无关代码模块化，消除了硬编码假设。经过精心工程优化，EMT在关键操作系统操作上的平均开销低于0.5%，同时完整保留了标准Linux的所有特性和硬件专属优化。

基于EMT-Linux，我们新增了对两种新型转换架构的支持：

* 弹性布谷鸟页表(ECPT)
* 扁平页表(FPT)

若无EMT框架，在Linux上移植这些新硬件方案需要重写大部分内存管理模块代码。而通过EMT，可以用可控的工程量实现模块化支持。

在EMT-Linux上评估新型硬件方案面临硬件-软件协同设计的共同挑战——硬件实体尚未就绪以运行操作系统。为解决这一问题，我们构建了在QEMU上运行EMT-Linux的工具链，通过模拟MMU实现硬件转换逻辑。该工具链使我们能够从操作系统视角理解新型转换架构的特性，包括相比x86架构的OS开销，同时支持周期精确的硬件模拟。

我们分享了在EMT-Linux上支持新型转换架构的经验，这些经验揭示了超越硬件视角的操作系统内存管理挑战。具体包括：在ECPT设计中需要解决内核页表(kECPT)管理的正确性挑战——即修改kECPT自身及其管理代码的转换条目时存在的自引用悖论；以及性能挑战，如高效锁机制和内存扫描优化。可以说，操作系统框架支持对鼓励和接纳颠覆性硬件创新至关重要，而EMT框架在这一方向上迈出了重要一步。



### Summary